<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hormur - Préférences</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#EE6553',
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #EE6553;
      --text: #111;
    }
    body {
      font-family: 'Inter', sans-serif;
      color: var(--text);
    }
    .btn-primary {
      background-color: var(--primary);
      transition: filter 0.2s;
    }
    .btn-primary:hover {
      filter: brightness(1.08);
    }
    .btn-selection {
      border: 1px solid #ddd;
      transition: all 0.2s;
    }
    .btn-selection.selected {
      background-color: rgba(238, 101, 83, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }
    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 1px var(--primary);
    }
    .toast {
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    /* Styles pour la modale */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal.open {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background-color: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal.open .modal-content {
      transform: translateY(0);
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
    }
    .category-badge {
      position: relative;
    }
    .category-counter {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--primary);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .subcategory-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    @media (min-width: 640px) {
      .subcategory-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .city-suggestions {
      position: absolute;
      width: 100%;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
    }
    .city-suggestion {
      padding: 8px 16px;
      cursor: pointer;
    }
    .city-suggestion:hover {
      background-color: #f3f4f6;
    }
    .selected-subcategories {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .subcategory-tag {
      background-color: rgba(238, 101, 83, 0.1);
      color: var(--primary);
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
    }
    .subcategory-tag .close {
      margin-left: 0.5rem;
      cursor: pointer;
      font-weight: bold;
    }
    .save-button {
      position: relative;
      margin-top: 1rem;
      width: auto;
      margin-left: auto;
      margin-right: auto;
      min-width: 220px;
      max-width: 90%;
    }
    @media (max-width: 640px) {
      .save-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        min-width: 220px;
        max-width: calc(100% - 40px);
        border-radius: 999px !important;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 40; /* Assurer qu'il soit toujours visible */
      }
      /* Ajout pour le padding supplémentaire en bas sur mobile */
      .form-container {
        padding-bottom: 80px; /* Espace pour le bouton fixe */
      }
    }

    /* Styles pour le bouton Surprenez-moi */
    .surprise-btn {
      background: linear-gradient(135deg, #FFF5F3 0%, #FEE9E5 100%);
      border: 2px dashed var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    .surprise-btn:hover {
      background: linear-gradient(135deg, #FEE9E5 0%, #FDDDD8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(238, 101, 83, 0.2);
    }
    .surprise-btn.selected {
      background: var(--primary);
      border-style: solid;
      color: white;
    }
    .surprise-btn.selected .surprise-icon {
      animation: sparkle 1s ease-in-out;
    }
    .surprise-btn .surprise-subtitle {
      font-weight: 400;
      opacity: 0.8;
    }
    @keyframes sparkle {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Mode désactivé pour les catégories quand Surprenez-moi est actif */
    .categories-disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .categories-disabled .btn-selection {
      filter: grayscale(0.5);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center bg-gray-50 p-4 pb-24">
  <div class="container max-w-md mx-auto md:max-w-lg">
    <div class="mb-6 flex justify-center">
      <a href="#" class="inline-block">
        <img src="https://cdn.usestencil.com/uploads/15a569bc-3bde-45e7-bad1-cc691194f1f5/2027f087-1a72-4ad1-97f2-af1bdad55850/Logo_couleurpng_Plan_de_travail_1_copie%20(1)%20(4)-1754519156.png" alt="Hormur" class="h-8">
      </a>
    </div>
    
    <div class="bg-white rounded-xl shadow-md p-6 form-container">
      <h1 class="text-2xl font-bold mb-6 text-center">Vos préférences</h1>
      
      <form id="preferencesForm" class="space-y-6">
        <input type="hidden" id="email" name="email" value="demo@hormur.com">
        <input type="hidden" id="cityField" name="CITY">
        <input type="hidden" id="zipField" name="ZIP">
        <input type="hidden" id="latField" name="LAT">
        <input type="hidden" id="lngField" name="LNG">
        <input type="hidden" id="departmentField" name="DEPARTMENT">
        <input type="hidden" id="regionField" name="REGION">
        
        <div class="space-y-3 relative">
          <label for="location" class="block font-medium">Localisation <span class="text-red-500">*</span></label>
          <input type="text" id="location" 
                 class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:border-primary" 
                 placeholder="Ville ou code postal" autocomplete="off">
          <div id="locationSuggestions" class="city-suggestions hidden"></div>
        </div>
        
        <div class="space-y-3">
          <label class="block font-medium">Préférences artistiques <span class="text-red-500">*</span></label>

          <!-- Bouton Surprenez-moi -->
          <button type="button" id="surpriseMeBtn" class="surprise-btn w-full py-3 px-4 rounded-xl text-sm font-medium flex items-center justify-center gap-2">
            <span class="surprise-icon">✨</span>
            <span>Surprenez-moi !</span>
            <span class="surprise-subtitle">— Recevez des suggestions variées</span>
          </button>

          <div class="separator flex items-center gap-3 my-2">
            <div class="flex-1 h-px bg-gray-200"></div>
            <span class="text-xs text-gray-400">ou choisissez vos préférences</span>
            <div class="flex-1 h-px bg-gray-200"></div>
          </div>

          <div id="categoriesWrapper">
            <div class="flex flex-wrap gap-3 mb-2">
              <button type="button" id="expositionsBtn" class="category-badge btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">
                Expositions
                <span class="category-counter hidden">0</span>
              </button>
              <button type="button" id="spectaclesBtn" class="category-badge btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">
                Spectacles
                <span class="category-counter hidden">0</span>
              </button>
              <button type="button" id="concertsBtn" class="category-badge btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">
                Concerts
                <span class="category-counter hidden">0</span>
              </button>
              <button type="button" id="numeriquesBtn" class="category-badge btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">
                Arts numériques
                <span class="category-counter hidden">0</span>
              </button>
              <button type="button" id="ateliersBtn" class="category-badge btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">
                Ateliers
                <span class="category-counter hidden">0</span>
              </button>
            </div>

            <div id="selectedSubcategories" class="selected-subcategories"></div>
          </div>
        </div>
        
        <div class="space-y-3">
          <label class="block font-medium">Préférences de lieu (facultatif)</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" data-value="Logement" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Logement</button>
            <button type="button" data-value="Extérieur" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Extérieur</button>
            <button type="button" data-value="Convivialité" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Convivialité</button>
            <button type="button" data-value="Établissement" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Établissement</button>
            <button type="button" data-value="Entreprise" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Entreprise</button>
            <button type="button" data-value="Atypique" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Atypique</button>
            <button type="button" data-value="Culte" class="venue-btn btn-selection py-2 px-4 rounded-lg text-sm" role="switch" aria-pressed="false">Lieu de culte</button>
          </div>
        </div>
        
        <p class="text-xs text-gray-500 mt-3 mb-2 text-center">
          J'accepte de recevoir des recommandations d'événements proches.
        </p>
        
        <div class="flex justify-center pt-4">
          <button type="submit" id="submitBtn" class="save-button py-2 px-5 text-white font-semibold rounded-xl bg-primary">
            Sauvegarder mes préférences
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Toast de notification (success) -->
  <div id="toastSuccess" class="toast fixed bottom-5 bg-primary text-white p-4 rounded-lg shadow-lg z-50">
    Merci !
  </div>
  
  <!-- Toast d'erreur -->
  <div id="toastError" class="toast fixed bottom-5 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50">
    Veuillez remplir tous les champs obligatoires.
  </div>
  
  <!-- Modal de confirmation et redirection -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="text-xl font-bold">Préférences sauvegardées !</h2>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="flex justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-[#EE6553]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <p class="mb-4 text-gray-600">Vos préférences ont été enregistrées avec succès.</p>
          <p id="redirectMessage" class="mb-4 text-gray-600">Vous allez être redirigé vers les événements qui correspondent à vos goûts...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="redirectNowBtn" class="px-6 py-2 bg-[#EE6553] text-white rounded-lg font-bold hover:bg-opacity-90">
          Découvrir les événements maintenant
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modales pour les catégories -->
  <!-- Expositions -->
  <div id="expositionsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Types d'expositions</h3>
          <button class="modal-close text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <input type="text" class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg" 
                 placeholder="Rechercher un type d'exposition...">
        </div>
      </div>
      <div class="modal-body">
        <div class="subcategory-grid">
          <!-- Les sous-catégories seront générées dynamiquement -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-between w-full">
          <button class="modal-close px-4 py-2 border rounded-lg font-medium hover:bg-gray-100">Annuler</button>
          <button class="validate-selection px-6 py-2 bg-primary text-white rounded-xl font-bold hover:opacity-90" data-category="expositions">Valider</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Spectacles -->
  <div id="spectaclesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Types de spectacles</h3>
          <button class="modal-close text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <input type="text" class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg" 
                 placeholder="Rechercher un type de spectacle...">
        </div>
      </div>
      <div class="modal-body">
        <div class="subcategory-grid">
          <!-- Les sous-catégories de spectacles seront générées dynamiquement -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-between w-full">
          <button class="modal-close px-4 py-2 border rounded-lg font-medium hover:bg-gray-100">Annuler</button>
          <button class="validate-selection px-6 py-2 bg-primary text-white rounded-xl font-bold hover:opacity-90" data-category="spectacles">Valider</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Concerts -->
  <div id="concertsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Genres musicaux</h3>
          <button class="modal-close text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <input type="text" class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg" 
                 placeholder="Rechercher un genre musical...">
        </div>
      </div>
      <div class="modal-body">
        <div class="subcategory-grid">
          <!-- Les sous-catégories de concerts seront générées dynamiquement -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-between w-full">
          <button class="modal-close px-4 py-2 border rounded-lg font-medium hover:bg-gray-100">Annuler</button>
          <button class="validate-selection px-6 py-2 bg-primary text-white rounded-xl font-bold hover:opacity-90" data-category="concerts">Valider</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Arts numériques -->
  <div id="numeriquesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Types d'arts numériques</h3>
          <button class="modal-close text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <input type="text" class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg" 
                 placeholder="Rechercher un type d'art numérique...">
        </div>
      </div>
      <div class="modal-body">
        <div class="subcategory-grid">
          <!-- Les sous-catégories d'arts numériques seront générées dynamiquement -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-between w-full">
          <button class="modal-close px-4 py-2 border rounded-lg font-medium hover:bg-gray-100">Annuler</button>
          <button class="validate-selection px-6 py-2 bg-primary text-white rounded-xl font-bold hover:opacity-90" data-category="numeriques">Valider</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Ateliers -->
  <div id="ateliersModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Types d'ateliers</h3>
          <button class="modal-close text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="mt-2">
          <input type="text" class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg" 
                 placeholder="Rechercher un type d'atelier...">
        </div>
      </div>
      <div class="modal-body">
        <div class="subcategory-grid">
          <!-- Les sous-catégories d'ateliers seront générées dynamiquement -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-between w-full">
          <button class="modal-close px-4 py-2 border rounded-lg font-medium hover:bg-gray-100">Annuler</button>
          <button class="validate-selection px-6 py-2 bg-primary text-white rounded-xl font-bold hover:opacity-90" data-category="ateliers">Valider</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration en mode DEBUG - désactiver en production
      const DEBUG = true;
      
      // Définition des sous-catégories
      const subcategories = {
        expositions: [
          "Art contemporain", "Arts plastiques", "Calligraphie", "Céramique", "Conceptuel", 
          "Design", "Dessin", "Enluminure", "Graphisme", "Graphitti", "Gravure", 
          "Installation artistique", "Land art", "Mangaka", "Marqueterie", "Métallier", 
          "Mosaïste", "Peinture", "Photographie", "Poterie", "Scénographie", "Sculpture", 
          "Sgraffito", "Street art", "Textile", "Verrier", "Installation multimédia", 
          "Gravure sur bois", "Collage", "Art mural", "Peinture corporelle", "Art miniature"
        ],
        spectacles: [
          "Animation", "Arts de la rue", "Art-thérapie", "Cabaret", "Cirque", "Cirque Chinois", 
          "Clown", "Comédie musicale", "Conférence", "Conte", "Danse", "Escrime artistique", 
          "Happening", "Humour", "Illusionniste", "Improvisation", "Lecture", "Magie", 
          "Marionnette", "Mime", "Ombres Chinoises", "Opéra", "Opérette", "Performance", 
          "Pluridisciplinaire", "Poésie", "Seul en scène", "Slam", "Théâtre", "Théâtre action", 
          "Théâtre d'objets", "Théâtre de rue", "Théâtre forum", "Théâtre d'ombres", 
          "Théâtre musical", "Comédie", "Stand-up", "Théâtre immersif", "Littérature"
        ],
        concerts: [
          "A capella", "Africaine", "Alternative", "Beatbox", "Bluegrass", "Blues", 
          "Bossa nova", "Chanson française", "Chant", "Chant lyrique", "Chorale", "Classique", 
          "Country", "Cubain", "Cumbia", "DJ", "Electronique", "Experimental", "Folk", "Funk", 
          "Gospel", "Guinguette", "Hard rock", "Hip-hop", "Improvisation musicale", "Indie", 
          "Instrumental", "Jam Session", "Jazz", "Jazz manouche", "Latino", "Lounge", "Metal", 
          "Musicothérapie", "Musique du monde", "Musique Irlandaise", "New Orleans", "Pianiste", 
          "Pop", "Punk", "R&B", "Rap", "Reggae", "Rock", "Rock and roll", "Rock progressif", 
          "Salsa", "Ska", "Soul", "Swing", "Techno", "Variété", "Body music", "Musique baroque", 
          "Musique électronique", "Musique folklorique", "Musique contemporaine", 
          "Chanson humoristique", "Musique expérimentale", "Musique ethnique", "Musique électronique ambiante"
        ],
        numeriques: [
          "Art de l'animation", "Art de la 3D", "Art drone", "Art du code", "Art génératif", 
          "Art immersif", "Art interactif", "Art robotique", "Art sonore", "Art web", "Bio art", 
          "Cinéma", "Data art", "IA", "Installation numérique", "Light painting", "Mapping", 
          "Motion design", "Musique électronique", "Net art", "Performance audiovisuelle", 
          "Programmation créative", "Projection", "Réalité augmentée", "Robotique", "Vidéo", 
          "Vjing", "Art virtuel", "Art en réseau", "Art vidéo", "Art holographique", "Art VR", 
          "Art AR", "Art sonore numérique"
        ],
        ateliers: [
          "Atelier écriture", "Atelier lecture", "Atelier peinture", "Atelier théâtre", 
          "Atelier danse", "Atelier cinéma", "Atelier musical", "Atelier d'improvisation", 
          "Atelier dessin", "Atelier d'art thérapie", "Atelier de musico thérapie", 
          "Atelier d'acrobatie", "Atelier yoga", "Atelier chant", "Atelier pluridisciplinaire", 
          "Atelier photographie", "Atelier sculpture", "Atelier couture", "Atelier poterie", 
          "Atelier multimédia", "Atelier de gravure", "Atelier de mosaïque", 
          "Atelier de calligraphie", "Atelier de photographie", "Atelier de sculpture", 
          "Atelier de poterie", "Atelier de couture", "Atelier de bijouterie", 
          "Atelier de création de bandes dessinées"
        ]
      };
      
      // Mapping pour les grandes catégories d'art (formulaire -> sheet)
      const artCategoryMapping = {
        "Expositions": "Arts visuels",
        "Spectacles": "Arts vivants",
        "Concerts": "Musique",
        "Arts numériques": "Arts numériques",
        "Ateliers": "Arts vivants" // Par défaut, à ajuster selon le type d'atelier
      };
      
      // Mapping pour les grandes catégories de lieu (formulaire -> sheet)
      const venueCategoryMapping = {
        "Logement": "Logement / Pièce",
        "Extérieur": "Espace extérieur",
        "Convivialité": "Lieu de convivialité",
        "Établissement": "Établissement",
        "Entreprise": "Entreprise",
        "Atypique": "Lieu d'exception",
        "Culte": "Lieu de culte"
      };
      
      // Mappage des départements et régions
      const departmentRegions = {
        "01": { name: "Ain", region: "Auvergne-Rhône-Alpes" },
        "02": { name: "Aisne", region: "Hauts-de-France" },
        "03": { name: "Allier", region: "Auvergne-Rhône-Alpes" },
        "04": { name: "Alpes-de-Haute-Provence", region: "Provence-Alpes-Côte d'Azur" },
        "05": { name: "Hautes-Alpes", region: "Provence-Alpes-Côte d'Azur" },
        "06": { name: "Alpes-Maritimes", region: "Provence-Alpes-Côte d'Azur" },
        "07": { name: "Ardèche", region: "Auvergne-Rhône-Alpes" },
        "08": { name: "Ardennes", region: "Grand Est" },
        "09": { name: "Ariège", region: "Occitanie" },
        "10": { name: "Aube", region: "Grand Est" },
        "11": { name: "Aude", region: "Occitanie" },
        "12": { name: "Aveyron", region: "Occitanie" },
        "13": { name: "Bouches-du-Rhône", region: "Provence-Alpes-Côte d'Azur" },
        "14": { name: "Calvados", region: "Normandie" },
        "15": { name: "Cantal", region: "Auvergne-Rhône-Alpes" },
        "16": { name: "Charente", region: "Nouvelle-Aquitaine" },
        "17": { name: "Charente-Maritime", region: "Nouvelle-Aquitaine" },
        "18": { name: "Cher", region: "Centre-Val de Loire" },
        "19": { name: "Corrèze", region: "Nouvelle-Aquitaine" },
        "21": { name: "Côte-d'Or", region: "Bourgogne-Franche-Comté" },
        "22": { name: "Côtes-d'Armor", region: "Bretagne" },
        "23": { name: "Creuse", region: "Nouvelle-Aquitaine" },
        "24": { name: "Dordogne", region: "Nouvelle-Aquitaine" },
        "25": { name: "Doubs", region: "Bourgogne-Franche-Comté" },
        "26": { name: "Drôme", region: "Auvergne-Rhône-Alpes" },
        "27": { name: "Eure", region: "Normandie" },
        "28": { name: "Eure-et-Loir", region: "Centre-Val de Loire" },
        "29": { name: "Finistère", region: "Bretagne" },
        "2A": { name: "Corse-du-Sud", region: "Corse" },
        "2B": { name: "Haute-Corse", region: "Corse" },
        "30": { name: "Gard", region: "Occitanie" },
        "31": { name: "Haute-Garonne", region: "Occitanie" },
        "32": { name: "Gers", region: "Occitanie" },
        "33": { name: "Gironde", region: "Nouvelle-Aquitaine" },
        "34": { name: "Hérault", region: "Occitanie" },
        "35": { name: "Ille-et-Vilaine", region: "Bretagne" },
        "36": { name: "Indre", region: "Centre-Val de Loire" },
        "37": { name: "Indre-et-Loire", region: "Centre-Val de Loire" },
        "38": { name: "Isère", region: "Auvergne-Rhône-Alpes" },
        "39": { name: "Jura", region: "Bourgogne-Franche-Comté" },
        "40": { name: "Landes", region: "Nouvelle-Aquitaine" },
        "41": { name: "Loir-et-Cher", region: "Centre-Val de Loire" },
        "42": { name: "Loire", region: "Auvergne-Rhône-Alpes" },
        "43": { name: "Haute-Loire", region: "Auvergne-Rhône-Alpes" },
        "44": { name: "Loire-Atlantique", region: "Pays de la Loire" },
        "45": { name: "Loiret", region: "Centre-Val de Loire" },
        "46": { name: "Lot", region: "Occitanie" },
        "47": { name: "Lot-et-Garonne", region: "Nouvelle-Aquitaine" },
        "48": { name: "Lozère", region: "Occitanie" },
        "49": { name: "Maine-et-Loire", region: "Pays de la Loire" },
        "50": { name: "Manche", region: "Normandie" },
        "51": { name: "Marne", region: "Grand Est" },
        "52": { name: "Haute-Marne", region: "Grand Est" },
        "53": { name: "Mayenne", region: "Pays de la Loire" },
        "54": { name: "Meurthe-et-Moselle", region: "Grand Est" },
        "55": { name: "Meuse", region: "Grand Est" },
        "56": { name: "Morbihan", region: "Bretagne" },
        "57": { name: "Moselle", region: "Grand Est" },
        "58": { name: "Nièvre", region: "Bourgogne-Franche-Comté" },
        "59": { name: "Nord", region: "Hauts-de-France" },
        "60": { name: "Oise", region: "Hauts-de-France" },
        "61": { name: "Orne", region: "Normandie" },
        "62": { name: "Pas-de-Calais", region: "Hauts-de-France" },
        "63": { name: "Puy-de-Dôme", region: "Auvergne-Rhône-Alpes" },
        "64": { name: "Pyrénées-Atlantiques", region: "Nouvelle-Aquitaine" },
        "65": { name: "Hautes-Pyrénées", region: "Occitanie" },
        "66": { name: "Pyrénées-Orientales", region: "Occitanie" },
        "67": { name: "Bas-Rhin", region: "Grand Est" },
        "68": { name: "Haut-Rhin", region: "Grand Est" },
        "69": { name: "Rhône", region: "Auvergne-Rhône-Alpes" },
        "70": { name: "Haute-Saône", region: "Bourgogne-Franche-Comté" },
        "71": { name: "Saône-et-Loire", region: "Bourgogne-Franche-Comté" },
        "72": { name: "Sarthe", region: "Pays de la Loire" },
        "73": { name: "Savoie", region: "Auvergne-Rhône-Alpes" },
        "74": { name: "Haute-Savoie", region: "Auvergne-Rhône-Alpes" },
        "75": { name: "Paris", region: "Île-de-France" },
        "76": { name: "Seine-Maritime", region: "Normandie" },
        "77": { name: "Seine-et-Marne", region: "Île-de-France" },
        "78": { name: "Yvelines", region: "Île-de-France" },
        "79": { name: "Deux-Sèvres", region: "Nouvelle-Aquitaine" },
        "80": { name: "Somme", region: "Hauts-de-France" },
        "81": { name: "Tarn", region: "Occitanie" },
        "82": { name: "Tarn-et-Garonne", region: "Occitanie" },
        "83": { name: "Var", region: "Provence-Alpes-Côte d'Azur" },
        "84": { name: "Vaucluse", region: "Provence-Alpes-Côte d'Azur" },
        "85": { name: "Vendée", region: "Pays de la Loire" },
        "86": { name: "Vienne", region: "Nouvelle-Aquitaine" },
        "87": { name: "Haute-Vienne", region: "Nouvelle-Aquitaine" },
        "88": { name: "Vosges", region: "Grand Est" },
        "89": { name: "Yonne", region: "Bourgogne-Franche-Comté" },
        "90": { name: "Territoire de Belfort", region: "Bourgogne-Franche-Comté" },
        "91": { name: "Essonne", region: "Île-de-France" },
        "92": { name: "Hauts-de-Seine", region: "Île-de-France" },
        "93": { name: "Seine-Saint-Denis", region: "Île-de-France" },
        "94": { name: "Val-de-Marne", region: "Île-de-France" },
        "95": { name: "Val-d'Oise", region: "Île-de-France" },
        "971": { name: "Guadeloupe", region: "Guadeloupe" },
        "972": { name: "Martinique", region: "Martinique" },
        "973": { name: "Guyane", region: "Guyane" },
        "974": { name: "La Réunion", region: "La Réunion" },
        "976": { name: "Mayotte", region: "Mayotte" }
      };
      
      // Fonctions utilitaires pour la normalisation des données
      const utils = {
        // Formater le nom de la ville pour le sheet (gestion des arrondissements)
        formatCityName: function(cityName, zipCode) {
          // Pour Paris
          if (cityName.includes("Paris") && cityName.includes("arrondissement")) {
            const arrMatch = cityName.match(/Paris\s+(\d+)(er|ème|e)\s+arrondissement/i);
            if (arrMatch && arrMatch[1]) {
              if (arrMatch[1] === "1") {
                return "Paris";
              } else {
                return `Paris ${arrMatch[1]}ème`;
              }
            }
          }
          
          // Pour Lyon
          if (cityName.includes("Lyon") && cityName.includes("arrondissement")) {
            const arrMatch = cityName.match(/Lyon\s+(\d+)(er|ème|e)\s+arrondissement/i);
            if (arrMatch && arrMatch[1]) {
              return `Lyon ${arrMatch[1]}${arrMatch[1] === "1" ? "er" : "eme"} Arrondissement`;
            }
          }
          
          // Pour Marseille
          if (cityName.includes("Marseille") && cityName.includes("arrondissement")) {
            const arrMatch = cityName.match(/Marseille\s+(\d+)(er|ème|e)\s+arrondissement/i);
            if (arrMatch && arrMatch[1]) {
              return `Marseille ${arrMatch[1]}${arrMatch[1] === "1" ? "er" : "ème"} Arrondissement`;
            }
          }
          
          // Pour les autres villes, première lettre en majuscule
          return cityName.charAt(0).toUpperCase() + cityName.slice(1);
        },
        
        // Obtenir le département et la région à partir du code postal
        getDepartmentAndRegion: function(zipCode) {
          if (!zipCode) return { department: "", region: "" };
          
          let deptCode = zipCode.substring(0, 2);
          
          // Cas spéciaux: DOM-TOM et Corse
          if (zipCode.startsWith("97")) {
            deptCode = zipCode.substring(0, 3);
          } else if (zipCode.startsWith("20")) {
            // Corse: distinguer 2A et 2B
            if (parseInt(zipCode) >= 20200) {
              deptCode = "2B"; // Haute-Corse
            } else {
              deptCode = "2A"; // Corse-du-Sud
            }
          }
          
          if (departmentRegions[deptCode]) {
            return {
              department: departmentRegions[deptCode].name,
              region: departmentRegions[deptCode].region
            };
          }
          
          return { department: "", region: "" };
        },
        
        // Déterminer la grande catégorie d'art pour un atelier
        getAtelierCategory: function(atelierName) {
          const lowerName = atelierName.toLowerCase();
          
          if (lowerName.includes("peinture") || lowerName.includes("dessin") || 
              lowerName.includes("sculpture") || lowerName.includes("photo")) {
            return "Arts visuels";
          } else if (lowerName.includes("théâtre") || lowerName.includes("danse") || 
                    lowerName.includes("cirque") || lowerName.includes("mime")) {
            return "Arts vivants";
          } else if (lowerName.includes("musique") || lowerName.includes("chant") || 
                    lowerName.includes("musical")) {
            return "Musique";
          } else if (lowerName.includes("numérique") || lowerName.includes("multimédia") || 
                    lowerName.includes("3d") || lowerName.includes("vidéo")) {
            return "Arts numériques";
          }
          
          // Par défaut
          return "Arts vivants";
        }
      };
      
      // Catégories et leurs noms
      const categoryMapping = {
        "expositions": "Expositions",
        "spectacles": "Spectacles",
        "concerts": "Concerts",
        "numeriques": "Arts numériques",
        "ateliers": "Ateliers"
      };
      
      // État des sélections
      const selections = {
        expositions: [],
        spectacles: [],
        concerts: [],
        numeriques: [],
        ateliers: []
      };

      // État du mode "Surprenez-moi"
      let surpriseMeMode = false;
      
      // Références aux éléments DOM
      const locationInput = document.getElementById('location');
      const cityField = document.getElementById('cityField');
      const zipField = document.getElementById('zipField');
      const latField = document.getElementById('latField');
      const lngField = document.getElementById('lngField');
      const departmentField = document.getElementById('departmentField');
      const regionField = document.getElementById('regionField');
      const locationSuggestions = document.getElementById('locationSuggestions');
      const selectedSubcategories = document.getElementById('selectedSubcategories');
      const venueButtons = document.querySelectorAll('.venue-btn');
      const toastSuccess = document.getElementById('toastSuccess');
      const toastError = document.getElementById('toastError');
      const emailField = document.getElementById('email');
      const surpriseMeBtn = document.getElementById('surpriseMeBtn');
      const categoriesWrapper = document.getElementById('categoriesWrapper');
      
      // Modales et boutons d'ouverture
      const categoryButtons = {
        expositions: document.getElementById('expositionsBtn'),
        spectacles: document.getElementById('spectaclesBtn'),
        concerts: document.getElementById('concertsBtn'),
        numeriques: document.getElementById('numeriquesBtn'),
        ateliers: document.getElementById('ateliersBtn')
      };
      
      const modals = {
        expositions: document.getElementById('expositionsModal'),
        spectacles: document.getElementById('spectaclesModal'),
        concerts: document.getElementById('concertsModal'),
        numeriques: document.getElementById('numeriquesModal'),
        ateliers: document.getElementById('ateliersModal')
      };
      
      // Populer les sous-catégories dans les modales
      Object.keys(subcategories).forEach(category => {
        const grid = modals[category].querySelector('.subcategory-grid');
        subcategories[category].forEach(subcategory => {
          const label = document.createElement('label');
          label.className = 'flex items-center p-2 border rounded-lg hover:bg-gray-50';
          label.innerHTML = `
            <input type="checkbox" name="sub_${category}" value="${subcategory}" class="mr-2">
            <span>${subcategory}</span>
          `;
          grid.appendChild(label);
        });
      });
      
      // Initialiser l'email depuis l'URL s'il existe
      const urlParams = new URLSearchParams(window.location.search);
      const emailFromUrl = urlParams.get('email');
      
      if (emailFromUrl) {
        emailField.value = emailFromUrl;
        if (DEBUG) console.log('Email trouvé dans l\'URL:', emailFromUrl);
        
        // Essayer de charger les préférences existantes
        tryLoadFromLocalStorage();
      } else {
        if (DEBUG) console.log('Email par défaut utilisé:', emailField.value);
      }
      
      // Fonction pour afficher un toast
      function showToast(toastElement, message) {
        if (message) {
          toastElement.textContent = message;
        }
        toastElement.classList.add('show');
        setTimeout(() => {
          toastElement.classList.remove('show');
        }, 3000);
      }
      
      // Fonction de debounce pour les appels API
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }
      
      // Fonctions pour les suggestions de localisation
      function hideSuggestions() {
        locationSuggestions.innerHTML = '';
        locationSuggestions.classList.add('hidden');
      }
      
      function showSuggestions(data) {
        locationSuggestions.innerHTML = '';
        
        if (data.length > 0) {
          locationSuggestions.classList.remove('hidden');
          
          data.forEach(commune => {
            const codePostal = commune.codesPostaux[0] || '';
            const div = document.createElement('div');
            div.className = 'city-suggestion';
            
            // Format: "Paris 2ᵉ (75002)" ou "69007 — Lyon 7ᵉ"
            let displayText = '';
            if (commune.nom.includes('arrondissement')) {
              displayText = commune.nom;
            } else if (codePostal.startsWith(commune.nom.substring(0, 2))) {
              displayText = `${codePostal} — ${commune.nom}`;
            } else {
              displayText = `${commune.nom} (${codePostal})`;
            }
            
            div.textContent = displayText;
            div.addEventListener('click', function() {
              locationInput.value = displayText;
              cityField.value = commune.nom;
              zipField.value = codePostal;
              locationSuggestions.classList.add('hidden');
              
              // CORRECTION: Récupérer correctement les coordonnées
              if (commune.centre && commune.centre.coordinates && 
                  commune.centre.coordinates.length === 2 && 
                  !isNaN(commune.centre.coordinates[0]) && 
                  !isNaN(commune.centre.coordinates[1])) {
                // API geo.api.gouv.fr renvoie les coordonnées au format [longitude, latitude]
                lngField.value = commune.centre.coordinates[0].toFixed(6);
                latField.value = commune.centre.coordinates[1].toFixed(6);
                if (DEBUG) console.log(`Coordonnées définies pour ${commune.nom}: ${latField.value}, ${lngField.value}`);
              } else {
                // Si pas de coordonnées valides, chercher via une API dédiée
                fetchGeoCoordinates(commune.nom, codePostal);
              }
              
              // Définir département et région
              const deptRegion = utils.getDepartmentAndRegion(codePostal);
              departmentField.value = deptRegion.department;
              regionField.value = deptRegion.region;
            });
            locationSuggestions.appendChild(div);
          });
        } else {
          locationSuggestions.classList.add('hidden');
        }
      }
      
      // NOUVELLE FONCTION: Récupération des coordonnées via API dédiée
      function fetchGeoCoordinates(cityName, zipCode) {
        // Utiliser l'API d'OpenStreetMap/Nominatim comme solution de secours
        const query = zipCode ? `${cityName}, ${zipCode}, France` : `${cityName}, France`;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data && data[0] && data[0].lat && data[0].lon) {
              latField.value = parseFloat(data[0].lat).toFixed(6);
              lngField.value = parseFloat(data[0].lon).toFixed(6);
              if (DEBUG) console.log(`Coordonnées récupérées via Nominatim: ${latField.value}, ${lngField.value}`);
            } else {
              // Ne définir les coordonnées par défaut QUE si aucune autre option n'a fonctionné
              if (!latField.value || !lngField.value) {
                // Centre de la France (près d'Orléans) au lieu de Lyon
                latField.value = "47.8734";
                lngField.value = "2.5864";
                if (DEBUG) console.log('Utilisation des coordonnées par défaut (centre de la France)');
              }
            }
          })
          .catch(error => {
            if (DEBUG) console.error('Erreur Nominatim:', error);
            // Ne définir les coordonnées par défaut QUE si aucune autre option n'a fonctionné
            if (!latField.value || !lngField.value) {
              // Centre de la France (près d'Orléans) au lieu de Lyon
              latField.value = "47.8734";
              lngField.value = "2.5864";
            }
          });
      }
      
      // Recherche de communes avec geo.api.gouv.fr
      const searchCommunes = debounce(function(q) {
        if (q.length < 2) { hideSuggestions(); return; }
        
        // Traitement spécial pour les codes postaux d'arrondissements
        if (/^75\d{3}$/.test(q)) { // Paris
          const arrNum = parseInt(q.substring(3), 10);
          if (arrNum >= 1 && arrNum <= 20) {
            const arrName = `Paris ${arrNum}${arrNum === 1 ? 'er' : 'ème'} arrondissement`;
            showSuggestions([{
              nom: arrName,
              codesPostaux: [q],
              centre: { coordinates: [2.3488, 48.8534] }
            }]);
            return;
          }
        } else if (/^69\d{3}$/.test(q)) { // Lyon
          const arrNum = parseInt(q.substring(3), 10);
          if (arrNum >= 1 && arrNum <= 9) {
            const arrName = `Lyon ${arrNum}${arrNum === 1 ? 'er' : 'ème'} arrondissement`;
            showSuggestions([{
              nom: arrName,
              codesPostaux: [q],
              centre: { coordinates: [4.8357, 45.7640] }
            }]);
            return;
          }
        } else if (/^13\d{3}$/.test(q)) { // Marseille
          const arrNum = parseInt(q.substring(3), 10);
          if (arrNum >= 1 && arrNum <= 16) {
            const arrName = `Marseille ${arrNum}${arrNum === 1 ? 'er' : 'ème'} arrondissement`;
            showSuggestions([{
              nom: arrName,
              codesPostaux: [q],
              centre: { coordinates: [5.3698, 43.2965] }
            }]);
            return;
          }
        }
        
        // Recherche normale par nom ou code postal - CORRECTION: ajout de fields pour avoir plus d'informations
        let url = '';
        if (/^\d{4,5}$/.test(q)) {
          url = `https://geo.api.gouv.fr/communes?codePostal=${q}&fields=nom,code,codesPostaux,centre,departement,region&limit=15`;
        } else {
          url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(q)}&fields=nom,code,codesPostaux,centre,departement,region&boost=population&limit=15`;
        }
        
        fetch(url)
          .then(r => r.json())
          .then(data => {
            // Pour le débogage
            if (DEBUG) console.log('Données API communes:', data);
            
            // Ajouter des arrondissements basés sur le nom
            if (!(/^\d{4,5}$/.test(q))) {
              let arrResults = [];
              
              // Chercher les arrondissements de Paris
              if (q.toLowerCase().includes('paris')) {
                for (let i = 1; i <= 20; i++) {
                  const arrName = `Paris ${i}${i === 1 ? 'er' : 'ème'} arrondissement`;
                  if (arrName.toLowerCase().includes(q.toLowerCase())) {
                    arrResults.push({
                      nom: arrName,
                      codesPostaux: [`750${i.toString().padStart(2, '0')}`],
                      centre: { coordinates: [2.3488, 48.8534] }
                    });
                  }
                }
              }
              
              // Chercher les arrondissements de Lyon
              if (q.toLowerCase().includes('lyon')) {
                for (let i = 1; i <= 9; i++) {
                  const arrName = `Lyon ${i}${i === 1 ? 'er' : 'ème'} arrondissement`;
                  if (arrName.toLowerCase().includes(q.toLowerCase())) {
                    arrResults.push({
                      nom: arrName,
                      codesPostaux: [`690${i.toString().padStart(2, '0')}`],
                      centre: { coordinates: [4.8357, 45.7640] }
                    });
                  }
                }
              }
              
              // Chercher les arrondissements de Marseille
              if (q.toLowerCase().includes('marseille')) {
                for (let i = 1; i <= 16; i++) {
                  const arrName = `Marseille ${i}${i === 1 ? 'er' : 'ème'} arrondissement`;
                  if (arrName.toLowerCase().includes(q.toLowerCase())) {
                    arrResults.push({
                      nom: arrName,
                      codesPostaux: [`130${i.toString().padStart(2, '0')}`],
                      centre: { coordinates: [5.3698, 43.2965] }
                    });
                  }
                }
              }
              
              // Montrer les résultats combinés (arrondissements + API)
              showSuggestions([...arrResults, ...data]);
            } else {
              showSuggestions(data);
            }
          })
          .catch((error) => {
            if (DEBUG) console.error('Erreur API geo.api.gouv.fr:', error);
            hideSuggestions();
          });
      }, 300);
      
      // AMÉLIORATION: Géolocalisation avec l'API native du navigateur en priorité
      function tryGeolocalization() {
        // Vérifier si déjà fait ou si l'utilisateur a déjà entré une localisation
        if (sessionStorage.getItem('geo_prefill_done') || locationInput.value) {
          return;
        }
        
        // Essayer d'abord la géolocalisation native du navigateur
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            // Succès
            function(position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              if (DEBUG) console.log(`Géolocalisation navigateur réussie: ${lat}, ${lng}`);
              
              // Enregistrer les coordonnées
              latField.value = lat.toFixed(6);
              lngField.value = lng.toFixed(6);
              
              // Faire une géocodage inverse pour obtenir la ville
              reverseGeocode(lat, lng);
              
              sessionStorage.setItem('geo_prefill_done', '1');
            },
            // Erreur
            function(error) {
              if (DEBUG) console.warn('Erreur de géolocalisation navigateur:', error.message);
              // Utiliser les services IP en fallback
              tryIPGeolocalization();
            },
            // Options
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0
            }
          );
        } else {
          // Si la géolocalisation n'est pas supportée
          if (DEBUG) console.warn('La géolocalisation n\'est pas supportée par ce navigateur');
          tryIPGeolocalization();
        }
      }
      
      // Nouvelle fonction: Géocodage inverse pour obtenir la ville à partir des coordonnées
      function reverseGeocode(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (DEBUG) console.log('Données de géocodage inverse:', data);
            
            if (data && data.address) {
              let city = data.address.city || data.address.town || data.address.village || data.address.hamlet;
              let postcode = data.address.postcode;
              
              if (city) {
                // Format d'affichage
                const displayLocation = postcode ? `${city} (${postcode})` : city;
                locationInput.value = displayLocation;
                cityField.value = city;
                
                if (postcode) {
                  zipField.value = postcode;
                  // Définir département et région
                  const deptRegion = utils.getDepartmentAndRegion(postcode);
                  departmentField.value = deptRegion.department;
                  regionField.value = deptRegion.region;
                }
                
                if (DEBUG) console.log(`Localisation résolue: ${city}, ${postcode}`);
              } else {
                if (DEBUG) console.warn('Impossible de déterminer la ville à partir des coordonnées');
                tryIPGeolocalization();
              }
            } else {
              tryIPGeolocalization();
            }
          })
          .catch(error => {
            if (DEBUG) console.error('Erreur de géocodage inverse:', error);
            tryIPGeolocalization();
          });
      }
      
      // Fonction unifiée de géolocalisation par IP améliorée
      function tryIPGeolocalization() {
        // Utiliser plusieurs services de géolocalisation par IP pour augmenter la précision
        // Définir un tableau d'APIs de géolocalisation par IP à essayer successivement
        const geoIpApis = [
          // Service Cloudflare - très précis pour les grandes villes françaises
          { url: 'https://cloudflare-geoloc.heyvaldemar.net/', parseFunction: parseCloudflareData },
          
          // ipinfo.io - service fiable avec un bon ratio de requêtes gratuites
          { url: 'https://ipinfo.io/json', parseFunction: parseIpInfoData },
          
          // ipwhois - service utilisé précédemment 
          { url: 'https://ipwho.is/', parseFunction: parseIpWhoisData },
          
          // ipapi.co - en dernier recours
          { url: 'https://ipapi.co/json', parseFunction: parseIpapiData }
        ];
        
        // Essayer chaque API séquentiellement jusqu'à ce qu'une donne une localisation française valide
        tryNextGeoApi(geoIpApis, 0);
        
        function tryNextGeoApi(apis, index) {
          if (index >= apis.length) {
            // Si toutes les APIs ont échoué, utiliser Paris comme fallback pour la France
            setDefaultParis();
            sessionStorage.setItem('geo_prefill_done', '1');
            return;
          }
          
          const api = apis[index];
          
          fetch(api.url)
            .then(response => response.json())
            .then(data => {
              if (DEBUG) console.log(`Données de ${api.url}:`, data);
              
              // Vérifier si les données sont valides et concernent la France
              const processed = api.parseFunction(data);
              
              if (processed && processed.valid && processed.isInFrance) {
                // Remplir les champs avec les données obtenues
                if (!locationInput.value) {
                  const displayLocation = processed.postal ? `${processed.city} (${processed.postal})` : processed.city;
                  locationInput.value = displayLocation;
                  cityField.value = processed.city;
                  
                  if (processed.postal) {
                    zipField.value = processed.postal;
                    // Définir département et région
                    const deptRegion = utils.getDepartmentAndRegion(processed.postal);
                    departmentField.value = deptRegion.department;
                    regionField.value = deptRegion.region;
                  }
                  
                  // Coordonnées
                  if (processed.latitude && processed.longitude) {
                    latField.value = processed.latitude.toFixed(6);
                    lngField.value = processed.longitude.toFixed(6);
                    if (DEBUG) console.log(`Coordonnées IP: ${latField.value}, ${lngField.value}`);
                  } else {
                    // Utiliser l'API OSM pour les coordonnées de la ville
                    fetchGeoCoordinates(processed.city, processed.postal);
                  }
                  
                  if (DEBUG) console.log(`Localisation IP résolue via ${api.url}: ${processed.city}, ${processed.postal}`);
                }
              } else {
                // Essayer l'API suivante
                tryNextGeoApi(apis, index + 1);
              }
            })
            .catch(err => {
              if (DEBUG) console.error(`Erreur avec ${api.url}:`, err);
              // Essayer l'API suivante
              tryNextGeoApi(apis, index + 1);
            });
        }
        
        // Définir Paris comme valeur par défaut en cas d'échec
        function setDefaultParis() {
          if (!locationInput.value) {
            const defaultCity = "Paris";
            const defaultPostal = "75001";
            locationInput.value = `${defaultCity} (${defaultPostal})`;
            cityField.value = defaultCity;
            zipField.value = defaultPostal;
            latField.value = "48.8566";
            lngField.value = "2.3522";
            
            // Définir département et région
            departmentField.value = "Paris";
            regionField.value = "Île-de-France";
            
            if (DEBUG) console.log("Utilisation de Paris comme localisation par défaut");
          }
        }
        
        // Fonctions de parsing pour chaque API
        function parseCloudflareData(data) {
          if (data && data.country && data.country.code === "FR" && data.city && data.city.name) {
            return {
              valid: true,
              isInFrance: true,
              city: data.city.name,
              region: data.region ? data.region.name : "",
              postal: data.postal ? data.postal.code : "",
              latitude: data.latitude,
              longitude: data.longitude
            };
          }
          return { valid: false };
        }
        
        function parseIpInfoData(data) {
          if (data && data.country === "FR" && data.city) {
            // Format du code postal dans ipinfo: "75001"
            return {
              valid: true,
              isInFrance: true,
              city: data.city,
              region: data.region || "",
              postal: data.postal || "",
              latitude: data.loc ? parseFloat(data.loc.split(",")[0]) : null,
              longitude: data.loc ? parseFloat(data.loc.split(",")[1]) : null
            };
          }
          return { valid: false };
        }
        
        function parseIpWhoisData(data) {
          if (data && data.success && data.country_code === "FR" && data.city) {
            return {
              valid: true,
              isInFrance: true,
              city: data.city,
              region: data.region || "",
              postal: data.postal || "",
              latitude: data.latitude,
              longitude: data.longitude
            };
          }
          return { valid: false };
        }
        
        function parseIpapiData(data) {
          if (data && !data.error && data.country_code === "FR" && data.city) {
            return {
              valid: true,
              isInFrance: true,
              city: data.city,
              region: data.region || "",
              postal: data.postal || "",
              latitude: data.latitude,
              longitude: data.longitude
            };
          }
          return { valid: false };
        }
      }
      
      // Fonction pour charger depuis le localStorage
      function tryLoadFromLocalStorage() {
        try {
          const savedPrefs = localStorage.getItem(`hormur_preferences_${emailField.value}`);
          if (savedPrefs) {
            const prefs = JSON.parse(savedPrefs);
            
            if (DEBUG) console.log('Préférences trouvées dans localStorage:', prefs);
            
            // Vérifier si l'email stocké correspond à celui de l'URL
            if (prefs.email === emailField.value) {
              populateFormWithPreferences(prefs);
              if (DEBUG) console.log('Préférences chargées depuis localStorage');
            }
          }
        } catch (error) {
          if (DEBUG) console.error('Erreur lors du chargement des préférences locales:', error);
        }
      }
      
      // Remplir le formulaire avec les préférences récupérées
      function populateFormWithPreferences(prefs) {
        // 1. Localisation
        if (prefs.CITY && prefs.ZIP) {
          locationInput.value = `${prefs.CITY} (${prefs.ZIP})`;
          cityField.value = prefs.CITY;
          zipField.value = prefs.ZIP;
          latField.value = prefs.LAT || '';
          lngField.value = prefs.LNG || '';
          departmentField.value = prefs.DEPARTMENT || '';
          regionField.value = prefs.REGION || '';
        }

        // 1.5 Mode "Surprenez-moi"
        if (prefs.SURPRISE_MODE === "true") {
          surpriseMeMode = true;
          surpriseMeBtn.classList.add('selected');
          categoriesWrapper.classList.add('categories-disabled');
          if (DEBUG) console.log('Mode "Surprenez-moi" restauré depuis les préférences');
          // Ne pas retourner ici pour permettre la restauration des préférences de lieu
        } else {
          // 2. Préférences artistiques (seulement si pas en mode Surprenez-moi)
          const categoryNames = ['expositions', 'spectacles', 'concerts', 'numeriques', 'ateliers'];
          categoryNames.forEach(category => {
            if (prefs[category]) {
              // Convertir la liste séparée par points-virgules en tableau
              selections[category] = prefs[category].split(';').filter(item => item.trim() !== '');

              // Mettre à jour le bouton et le compteur
              const counter = categoryButtons[category].querySelector('.category-counter');
              if (selections[category].length > 0) {
                counter.textContent = selections[category].length;
                counter.classList.remove('hidden');
                categoryButtons[category].classList.add('selected');
                categoryButtons[category].setAttribute('aria-pressed', 'true');
              }
            }
          });

          // Mettre à jour les badges de sous-catégories
          updateSelectedSubcategories();
        }

        // 3. Préférences de lieu (toujours restaurées)
        const venueTypes = ["Logement", "Extérieur", "Convivialité", "Établissement", "Entreprise", "Atypique", "Culte"];
        if (prefs.LIEU_TAGS) {
          const selectedVenues = prefs.LIEU_TAGS.split(';');
          
          venueButtons.forEach(button => {
            const venueType = button.dataset.value;
            if (selectedVenues.includes(venueType)) {
              button.classList.add('selected');
              button.setAttribute('aria-pressed', 'true');
            }
          });
        }
      }
      
      // Fonction pour valider les coordonnées avant soumission
      function validateCoordinates() {
        // Si la localisation est définie mais pas les coordonnées ou si elles sont les valeurs par défaut
        if (cityField.value && (!latField.value || !lngField.value || 
            (latField.value === "45.7578" && lngField.value === "4.8320"))) {
          // Forcer la récupération des coordonnées
          return new Promise((resolve) => {
            fetchGeoCoordinates(cityField.value, zipField.value);
            // Attendre un peu pour que la requête ait le temps de s'exécuter
            setTimeout(resolve, 1000);
          });
        }
        return Promise.resolve();
      }
      
      // Initialisation: Essayer la géolocalisation
      tryGeolocalization();
      
      // Écouter les saisies dans le champ localisation
      locationInput.addEventListener('input', function() {
        searchCommunes(this.value);
        // Si l'utilisateur modifie le champ manuellement, on réinitialise les champs de city/zip pour éviter l'incohérence
        if (cityField.value || zipField.value) {
          cityField.value = '';
          zipField.value = '';
          latField.value = '';
          lngField.value = '';
          departmentField.value = '';
          regionField.value = '';
        }
      });
      
      // Masquer les suggestions quand on clique ailleurs
      document.addEventListener('click', function(e) {
        if (e.target !== locationInput && e.target !== locationSuggestions) {
          locationSuggestions.classList.add('hidden');
        }
      });
      
      // Gestionnaire du bouton "Surprenez-moi !"
      surpriseMeBtn.addEventListener('click', function() {
        surpriseMeMode = !surpriseMeMode;

        if (surpriseMeMode) {
          // Activer le mode "Surprenez-moi"
          this.classList.add('selected');

          // Désactiver visuellement les catégories
          categoriesWrapper.classList.add('categories-disabled');

          // Réinitialiser toutes les sélections de sous-catégories
          Object.keys(selections).forEach(category => {
            selections[category] = [];
            const counter = categoryButtons[category].querySelector('.category-counter');
            counter.classList.add('hidden');
            categoryButtons[category].classList.remove('selected');
            categoryButtons[category].setAttribute('aria-pressed', 'false');
          });

          // Vider les badges de sous-catégories
          selectedSubcategories.innerHTML = '';

          if (DEBUG) console.log('Mode "Surprenez-moi" activé');
        } else {
          // Désactiver le mode "Surprenez-moi"
          this.classList.remove('selected');

          // Réactiver les catégories
          categoriesWrapper.classList.remove('categories-disabled');

          if (DEBUG) console.log('Mode "Surprenez-moi" désactivé');
        }
      });

      // Désactiver le mode "Surprenez-moi" si l'utilisateur clique sur une catégorie
      function disableSurpriseMeIfActive() {
        if (surpriseMeMode) {
          surpriseMeMode = false;
          surpriseMeBtn.classList.remove('selected');
          categoriesWrapper.classList.remove('categories-disabled');
          if (DEBUG) console.log('Mode "Surprenez-moi" désactivé par sélection manuelle');
        }
      }

      // Ouvrir les modales des catégories
      Object.keys(categoryButtons).forEach(category => {
        categoryButtons[category].addEventListener('click', function() {
          disableSurpriseMeIfActive();
          modals[category].classList.add('open');
          
          // Mettre à jour les cases cochées selon les sélections actuelles
          const checkboxes = modals[category].querySelectorAll(`input[name="sub_${category}"]`);
          checkboxes.forEach(checkbox => {
            checkbox.checked = selections[category].includes(checkbox.value);
          });
        });
      });
      
      // Fermer les modales
      document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', function() {
          const modal = this.closest('.modal');
          if (modal) {
            modal.classList.remove('open');
          }
        });
      });
      
      // Valider les sélections dans les modales
      document.querySelectorAll('.validate-selection').forEach(button => {
        button.addEventListener('click', function() {
          const category = this.dataset.category;
          const modal = this.closest('.modal');
          
          if (modal && category) {
            // Récupérer les cases cochées
            const checkboxes = modal.querySelectorAll(`input[name="sub_${category}"]:checked`);
            
            // Mettre à jour les sélections
            selections[category] = Array.from(checkboxes).map(cb => cb.value);
            
            // Mettre à jour le compteur et l'apparence du bouton
            const counter = categoryButtons[category].querySelector('.category-counter');
            if (selections[category].length > 0) {
              counter.textContent = selections[category].length;
              counter.classList.remove('hidden');
              categoryButtons[category].classList.add('selected');
              categoryButtons[category].setAttribute('aria-pressed', 'true');
            } else {
              counter.classList.add('hidden');
              categoryButtons[category].classList.remove('selected');
              categoryButtons[category].setAttribute('aria-pressed', 'false');
            }
            
            // Mettre à jour les badges de sous-catégories
            updateSelectedSubcategories();
            
            // Fermer la modale
            modal.classList.remove('open');
          }
        });
      });
      
      // Recherche dans les modales
      document.querySelectorAll('.category-search').forEach(input => {
        input.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const modal = this.closest('.modal');
          
          if (modal) {
            const labels = modal.querySelectorAll('.subcategory-grid label');
            
            labels.forEach(label => {
              const text = label.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                label.style.display = 'flex';
              } else {
                label.style.display = 'none';
              }
            });
          }
        });
      });
      
      // Toggle pour les boutons de lieu
      venueButtons.forEach(button => {
        button.addEventListener('click', function() {
          this.classList.toggle('selected');
          const isPressed = this.classList.contains('selected');
          this.setAttribute('aria-pressed', isPressed ? 'true' : 'false');
        });
      });
      
      // Mise à jour des badges de sous-catégories sélectionnées
      function updateSelectedSubcategories() {
        selectedSubcategories.innerHTML = '';
        
        let hasSelections = false;
        
        Object.keys(selections).forEach(category => {
          if (selections[category].length > 0) {
            hasSelections = true;
            
            selections[category].forEach(subcategory => {
              const tag = document.createElement('div');
              tag.className = 'subcategory-tag';
              tag.innerHTML = `${subcategory} <span class="close" data-category="${category}" data-value="${subcategory}">×</span>`;
              selectedSubcategories.appendChild(tag);
            });
          }
        });
        
        // Ajouter des événements aux boutons de fermeture des badges
        document.querySelectorAll('.subcategory-tag .close').forEach(closeBtn => {
          closeBtn.addEventListener('click', function() {
            const category = this.dataset.category;
            const value = this.dataset.value;
            
            // Supprimer la sous-catégorie des sélections
            const index = selections[category].indexOf(value);
            if (index !== -1) {
              selections[category].splice(index, 1);
            }
            
            // Mettre à jour le compteur et l'apparence du bouton
            const counter = categoryButtons[category].querySelector('.category-counter');
            if (selections[category].length > 0) {
              counter.textContent = selections[category].length;
            } else {
              counter.classList.add('hidden');
              categoryButtons[category].classList.remove('selected');
              categoryButtons[category].setAttribute('aria-pressed', 'false');
            }
            
            // Mettre à jour les badges
            updateSelectedSubcategories();
          });
        });
      }
      
      // Fonction pour construire l'URL de redirection vers Hormur
      function buildRedirectUrl(city) {
        // Utiliser les coordonnées si disponibles
        const radius = "200"; // Modification du rayon à 200 km
        let lat = latField.value;
        let lng = lngField.value;
        
        return `https://hormur.com/event?ville=${encodeURIComponent(city)}&lat=${lat}&lng=${lng}&radius=${radius}`;
      }
      
      // Fonction pour afficher le modal de confirmation et gérer la redirection
      function showConfirmationModal(redirectUrl) {
        const modal = document.getElementById('confirmationModal');
        const redirectBtn = document.getElementById('redirectNowBtn');
        
        modal.classList.add('open');
        
        // Configurer le bouton de redirection immédiate
        redirectBtn.addEventListener('click', function() {
          window.location.href = redirectUrl;
        });
        
        // Redirection automatique après 5 secondes
        let countdown = 5;
        const redirectMessage = document.getElementById('redirectMessage');
        const countdownInterval = setInterval(() => {
          countdown--;
          redirectMessage.textContent = `Vous allez être redirigé vers les événements qui correspondent à vos goûts dans ${countdown} secondes...`;
          
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            window.location.href = redirectUrl;
          }
        }, 1000);
      }
      
      // Soumission du formulaire - VERSION OPTIMISÉE POUR MAKE/SHEETS
      document.getElementById('preferencesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Valider et corriger les coordonnées si nécessaire
        validateCoordinates().then(() => {
          // Récupération des catégories principales sélectionnées pour l'affichage
          let selectedMainCategories = [];
          let mappedArtCategories = [];

          if (surpriseMeMode) {
            // Mode "Surprenez-moi" : toutes les grandes catégories sont sélectionnées
            selectedMainCategories = ["Expositions", "Spectacles", "Concerts", "Arts numériques", "Ateliers"];
            mappedArtCategories = ["Arts visuels", "Arts vivants", "Musique", "Arts numériques"];

            if (DEBUG) console.log('Mode "Surprenez-moi" - Toutes les grandes catégories sélectionnées');
          } else {
            // Mode normal : récupérer les catégories depuis les sélections
            Object.keys(categoryMapping).forEach(category => {
              if (selections[category].length > 0) {
                selectedMainCategories.push(categoryMapping[category]);
              }
            });

            // Mapper les catégories d'art pour le sheet
            Object.keys(selections).forEach(category => {
              if (selections[category].length > 0) {
                const mainCategory = categoryMapping[category];
                const sheetCategory = artCategoryMapping[mainCategory];

                if (!mappedArtCategories.includes(sheetCategory)) {
                  mappedArtCategories.push(sheetCategory);
                }
              }
            });
          }
          
          // Récupération des préférences de lieu
          const selectedVenues = [];
          const mappedVenueCategories = [];
          
          venueButtons.forEach(button => {
            if (button.classList.contains('selected')) {
              const venueType = button.dataset.value;
              selectedVenues.push(venueType);
              
              // Mapper avec les catégories du sheet
              const sheetVenue = venueCategoryMapping[venueType];
              if (sheetVenue && !mappedVenueCategories.includes(sheetVenue)) {
                mappedVenueCategories.push(sheetVenue);
              }
            }
          });
          
          // Validation des champs obligatoires
          let missingFields = [];

          if (!cityField.value) missingFields.push('Ville');
          if (!zipField.value) missingFields.push('Code postal');
          // En mode "Surprenez-moi", les préférences sont automatiquement remplies
          if (!surpriseMeMode && selectedMainCategories.length === 0) {
            missingFields.push('Préférences artistiques');
          }

          if (missingFields.length > 0) {
            showToast(toastError, 'Veuillez remplir tous les champs obligatoires : ' + missingFields.join(', '));
            return;
          }
          
          // Formater le nom de la ville pour le sheet
          const formattedCityName = utils.formatCityName(cityField.value, zipField.value);
          
          // Structure des données aplatie pour une meilleure compatibilité avec Make/Sheets
          
          // 1. Créer les listes de sous-catégories par catégorie principale
          const artVisuelsSubcategories = [];
          const artsVivantsSubcategories = [];
          const musiqueSubcategories = [];
          const artsNumeriquesSubcategories = [];
          
          // Les sélections originales à plat pour chaque catégorie
          const expositionsSelected = selections.expositions || [];
          const spectaclesSelected = selections.spectacles || [];
          const concertsSelected = selections.concerts || [];
          const numeriquesSelected = selections.numeriques || [];
          const ateliersSelected = selections.ateliers || [];
          
          // Organiser les sous-catégories par catégorie de sheet
          if (expositionsSelected.length > 0) {
            artVisuelsSubcategories.push(...expositionsSelected);
          }
          
          if (spectaclesSelected.length > 0) {
            artsVivantsSubcategories.push(...spectaclesSelected);
          }
          
          if (concertsSelected.length > 0) {
            musiqueSubcategories.push(...concertsSelected);
          }
          
          if (numeriquesSelected.length > 0) {
            artsNumeriquesSubcategories.push(...numeriquesSelected);
          }
          
          // Pour les ateliers, on doit déterminer la catégorie en fonction du type
          if (ateliersSelected.length > 0) {
            ateliersSelected.forEach(subcat => {
              const atelierCategory = utils.getAtelierCategory(subcat);
              
              switch(atelierCategory) {
                case "Arts visuels":
                  artVisuelsSubcategories.push(subcat);
                  break;
                case "Arts vivants":
                  artsVivantsSubcategories.push(subcat);
                  break;
                case "Musique":
                  musiqueSubcategories.push(subcat);
                  break;
                case "Arts numériques":
                  artsNumeriquesSubcategories.push(subcat);
                  break;
              }
            });
          }
          
          // 2. Préparer les listes de lieux sélectionnés
          const venueExterior = selectedVenues.includes("Extérieur") ? "Extérieur" : "";
          const venueConvivialite = selectedVenues.includes("Convivialité") ? "Convivialité" : "";
          const venueLogement = selectedVenues.includes("Logement") ? "Logement" : "";
          const venueEtablissement = selectedVenues.includes("Établissement") ? "Établissement" : "";
          const venueEntreprise = selectedVenues.includes("Entreprise") ? "Entreprise" : "";
          const venueAtypique = selectedVenues.includes("Atypique") ? "Atypique" : "";
          const venueCulte = selectedVenues.includes("Culte") ? "Culte" : "";
          
          // Préparation des données finales
          const formData = {
            // Données de base
            email: emailField.value,
            CITY: formattedCityName,
            ZIP: zipField.value,
            LAT: latField.value,
            LNG: lngField.value,
            DEPARTMENT: departmentField.value,
            REGION: regionField.value,

            // Mode "Surprenez-moi" - flag pour le matching
            SURPRISE_MODE: surpriseMeMode ? "true" : "false",

            // Données pour Brevo
            ART_PREF: mappedArtCategories.join(';'),
            LIEU_PREF: mappedVenueCategories.join(';'),
            ART_TAGS: [...artVisuelsSubcategories, ...artsVivantsSubcategories, ...musiqueSubcategories, ...artsNumeriquesSubcategories].join(';'),
            LIEU_TAGS: selectedVenues.join(';'),
            
            // Grandes catégories d'art au format liste numérotée pour Make
            // Format: "1 Arts visuels\n2 Arts vivants\n..."
            ART_CATEGORIES_TEXT: mappedArtCategories.map((cat, index) => `${index + 1} ${cat}`).join('\n'),
            
            // Grandes catégories de lieu au format liste numérotée pour Make
            VENUE_CATEGORIES_TEXT: mappedVenueCategories.map((cat, index) => `${index + 1} ${cat}`).join('\n'),
            
            // Sous-catégories aplaties pour chaque grande catégorie d'art
            ARTS_VISUELS_SUBCATEGORIES: artVisuelsSubcategories.map((subcat, index) => `${index + 1} ${subcat}`).join('\n'),
            ARTS_VIVANTS_SUBCATEGORIES: artsVivantsSubcategories.map((subcat, index) => `${index + 1} ${subcat}`).join('\n'),
            MUSIQUE_SUBCATEGORIES: musiqueSubcategories.map((subcat, index) => `${index + 1} ${subcat}`).join('\n'),
            ARTS_NUMERIQUES_SUBCATEGORIES: artsNumeriquesSubcategories.map((subcat, index) => `${index + 1} ${subcat}`).join('\n'),
            
            // Sous-catégories de lieu en format texte numéroté
            VENUE_SUBCATEGORIES_TEXT: selectedVenues.map((subcat, index) => `${index + 1} ${subcat}`).join('\n'),
            
            // Format pour les lieux individuels
            EXTERIEUR: venueExterior,
            CONVIVIALITE: venueConvivialite,
            LOGEMENT: venueLogement,
            ETABLISSEMENT: venueEtablissement,
            ENTREPRISE: venueEntreprise, 
            ATYPIQUE: venueAtypique,
            CULTE: venueCulte,
            
            // Sélections originales pour un accès direct (format compatible Make)
            expositions: expositionsSelected.join(';'),
            spectacles: spectaclesSelected.join(';'),
            concerts: concertsSelected.join(';'),
            numeriques: numeriquesSelected.join(';'),
            ateliers: ateliersSelected.join(';'),
            
            // Pour Make, utiliser des noms de champs se terminant par "S"
            ART_PREFS: mappedArtCategories.join(';'),
            VENUE_PREFS: mappedVenueCategories.join(';'),
            SUBCATEGORIES: [...artVisuelsSubcategories, ...artsVivantsSubcategories, ...musiqueSubcategories, ...artsNumeriquesSubcategories].join(';'),
            
            // Original Art Preferences (conserver pour la compatibilité)
            ORIGINAL_ART_PREF: selectedMainCategories.join(';')
          };
          
          // Affichage des données envoyées en mode debug
          if (DEBUG) {
            console.log("--- Données formatées pour Brevo et le sheet ---");
            console.log(JSON.stringify(formData, null, 2));
          }
          
          // Afficher l'état de chargement
          const submitBtn = document.getElementById('submitBtn');
          submitBtn.innerHTML = 'Envoi en cours...';
          submitBtn.disabled = true;
          
          // Construire l'URL de redirection
          const redirectUrl = buildRedirectUrl(formattedCityName);
          
          // Envoi des données au webhook
          fetch('https://hook.eu1.make.com/tw8g22xu5dyulrui9613awqrw6p8rmfw', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          .then(response => {
            if (DEBUG) console.log('Réponse du webhook:', response.status);
            
            // Stocker les préférences localement avec l'email comme partie de la clé
            localStorage.setItem(`hormur_preferences_${emailField.value}`, JSON.stringify(formData));
            
            // Afficher la confirmation et rediriger
            showConfirmationModal(redirectUrl);
            
            return response.ok;
          })
          .catch(error => {
            if (DEBUG) console.error('Erreur lors de l\'envoi:', error);
            
            // Même en cas d'erreur, on continue avec la redirection pour la démo
            localStorage.setItem(`hormur_preferences_${emailField.value}`, JSON.stringify(formData));
            showConfirmationModal(redirectUrl);
          });
        });
      });
    });
  </script>
</body>
</html>
